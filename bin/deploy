#!/usr/bin/env bash

set -euo pipefail

abort_with_usage() {
  echo "USAGE: $0 ENVIRONMENT"
  echo "(where ENVIRONMENT is either 'staging' or 'production')"
  exit 1
}

if [[ $# -eq 0 ]]; then
  echo "Missing environment."
  echo
  abort_with_usage
fi

environment="$1"

case $environment in
  production|staging)
    export DEPLOYMENT_ENVIRONMENT="$environment"
    ;;
  *)
    echo "Invalid environment."
    echo
    abort_with_usage
    ;;
esac

bundle exec middleman build --verbose

if [[ $environment == "production" ]]; then
  npx netlify deploy --prod
else
  npx netlify deploy
fi
